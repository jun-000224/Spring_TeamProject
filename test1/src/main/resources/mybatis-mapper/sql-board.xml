<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.test1.mapper.BoardMapper">
	<select id="BoardList" parameterType="hashmap" resultType="com.example.test1.model.Board">
		SELECT 
		    B.*, 
		    DECODE(TO_CHAR(FROM_TZ(CAST(B.CDATETIME AS TIMESTAMP), 'UTC') AT TIME ZONE 'Asia/Seoul','YYYY-MM-DD'), TO_CHAR(SYSDATE, 'YYYY-MM-DD'),TO_CHAR(FROM_TZ(CAST(B.CDATETIME AS TIMESTAMP), 'UTC') AT TIME ZONE 'Asia/Seoul',
            'HH24:MI:SS'),TO_CHAR(FROM_TZ(CAST(CDATETIME AS TIMESTAMP), 'UTC') AT TIME ZONE 'Asia/Seoul','YYYY-MM-DD')) AS CDATE, 
		    NVL(CCNT, 0) AS COMMENTCNT , U.NICKNAME
		FROM TBL_BOARD B
		LEFT JOIN (
		    SELECT BOARDNO, COUNT(*) AS CCNT
		    FROM TBL_COMMENT
		    GROUP BY BOARDNO
		) T ON T.BOARDNO = B.BOARDNO
		INNER JOIN (
			SELECT U1.NICKNAME , U1.USER_ID
			FROM USERS U1
		) U ON B.USER_ID = U.USER_ID
		WHERE 1=1
		
		<if test="type != '' and type != null">
    	<!--AND TYPE LIKE '%' || #{type} || '%'-->
    	AND TRIM(TYPE) = #{type}
		</if>
		<if test="searchOption == 'all'">
		AND (TITLE LIKE '%' || #{keyword} || '%' OR
			B.USER_ID LIKE '%' || #{keyword} || '%'
			)
		 
		</if>
		
		<if test="searchOption == 'id'">
		AND B.USER_ID LIKE '%' || #{keyword} || '%' 
		</if>
		<if test="searchOption == 'title'">
		AND TITLE LIKE '%' || #{keyword} || '%' 
		</if>
		
		
		<if test="order == 'time'">
			ORDER BY B.CDATETIME DESC
		</if>
		<if test="order == 'num'">
			ORDER BY B.BOARDNO ASC
		</if>
		<if test="order == 'title'">
			ORDER BY TITLE ASC
		</if>
		<if test="order == 'cnt'">
			ORDER BY B.CNT DESC
		</if>
		OFFSET #{page} ROWS FETCH NEXT #{pageSize} ROWS ONLY
	</select>
	
	
	<select id="selectBoardCnt" parameterType="hashmap" resultType="int">
		SELECT COUNT(*) 
		FROM TBL_BOARD B
		
		WHERE 1=1
		
		
		<if test="type != '' and type != null">
    	<!--AND TYPE LIKE '%' || #{type} || '%'-->
    	AND TRIM(TYPE) = #{type}
		</if>
		<if test="searchOption == 'all'">
		AND (TITLE LIKE '%' || #{keyword} || '%' OR
			USER_ID LIKE '%' || #{keyword} || '%'
			)
		 
		</if>
		
		<if test="searchOption == 'id'">
		AND USER_ID LIKE '%' || #{keyword} || '%' 
		</if>
		<if test="searchOption == 'title'">
		AND TITLE LIKE '%' || #{keyword} || '%' 
		</if>
		
		
		
		
	</select>
	
	<select id="selectBoard" parameterType="hashmap" resultType="com.example.test1.model.Board">
		SELECT *
		FROM TBL_BOARD B
		INNER JOIN (
			SELECT *
			FROM USERS
		) U ON B.USER_ID = U.USER_ID
		WHERE BOARDNO = #{boardNo}
	</select>
	
	<select id="selectCommentList" parameterType="hashmap" resultType="com.example.test1.model.Comment">
		SELECT C.*, U.NICKNAME AS USERNICK, T.TITLE, T.STOR_URL, STATUS
		FROM TBL_BOARD B
		INNER JOIN TBL_COMMENT C ON B.BOARDNO = C.BOARDNO
		LEFT JOIN (
		    SELECT *
		    FROM MEDIA
		    WHERE STOR_URL LIKE '%_profile%'
		)T ON C.USER_ID = T.USER_ID
		INNER JOIN (
			SELECT *
			FROM USERS
		) U ON C.USER_ID = U.USER_ID
		WHERE C.BOARDNO = #{boardNo}
		ORDER BY C.CDATETIME ASC
	</select>
	<insert id="insertComment" parameterType="hashmap">
		INSERT INTO TBL_COMMENT
		VALUES(COMMENT_SEQ.NEXTVAL ,#{boardNo}, #{userId}, NULL , #{contents}, 'F', SYSDATE, SYSDATE, NULL)
	</insert>   
	
	<delete id="removeList" parameterType="hashmap">
		DELETE TBL_BOARD
		WHERE BOARDNO = #{boardNo}
	</delete>	
	
	<insert id="addBoard" parameterType="hashmap">
		INSERT INTO TBL_BOARD
		VALUES(BOARD_SEQ.NEXTVAL ,#{userId}, #{title}, #{contents} , 0 , 0 ,SYSDATE, SYSDATE, #{type}, 0)  
	</insert>
	
	<update id="updateCnt" parameterType="hashmap">
		UPDATE TBL_BOARD
		SET 
    		CNT = CNT + 1
    	WHERE BOARDNO = #{boardNo}
	</update>
	<delete id="viewRemove" parameterType="hashmap">
		DELETE TBL_BOARD
		WHERE BOARDNO = #{boardNo}
	</delete>	
	
	<update id="updateView" parameterType="hashmap">
		UPDATE TBL_BOARD
    	SET 
    	TITLE = #{title}, CONTENTS = #{contents} 
    	WHERE BOARDNO = #{boardNo}
	</update>
	
	<insert id="insertBoardImg" parameterType="hashmap">
		INSERT INTO MEDIA
		VALUES(MEDIA_SEQ.NEXTVAL, #{title}, #{path}, #{orgName}, 'F', #{userId}, #{boardNo})
	</insert>
	
	<select id = "selectFileList" parameterType="hashMap" resultType="com.example.test1.model.Board">
		SELECT * 
		FROM MEDIA
		WHERE BOARDNO = #{boardNo}
	</select>
	
	<delete id="viewComRemove" parameterType="hashmap">
	DELETE TBL_COMMENT
	WHERE COMMENTNO = #{commentNo}
	</delete>
	
	<update id="updateComment" parameterType="hashmap">
	UPDATE TBL_COMMENT
	SET
    CONTENTS = #{contents}
	WHERE COMMENTNO = #{commentNo}
	</update>
	
	<!--11.02-->
	<select id="selectComment" parameterType="hashmap" resultType="hashmap">
    SELECT COMMENTNO, USER_ID, CONTENTS, BOARDNO
    FROM TBL_COMMENT
    WHERE COMMENTNO = #{commentNo}
	</select>
	<!--채택하기-->
	<insert id="givePoint" parameterType="hashmap">
	INSERT INTO POINT (USER_ID, POINT_TOTAL, POINT_GET, POINT_OUT, POINT_DATE)
	 SELECT 
        #{userId},
        NVL((
            SELECT POINT_TOTAL
            FROM POINT
            WHERE USER_ID = #{userId}
              AND POINT_DATE = (
                  SELECT MAX(POINT_DATE)
                  FROM POINT
                  WHERE USER_ID = #{userId}
              )
        ), 0) + 100,   
        100,           
        NULL,          
        SYSDATE
        FROM DUAL
	</insert>
	
	<!-- 댓글 채택 상태 업데이트 -->
<update id="updateAdoptStatus" parameterType="hashmap">
    UPDATE TBL_COMMENT
    SET ADOPT = 'T'
    WHERE COMMENTNO = #{commentNo}
</update>

<update id="resetAdoptStatus" parameterType="hashmap">
    UPDATE TBL_COMMENT
    SET ADOPT = 'F'
    WHERE COMMENTNO = #{commentNo}
</update>
	
	<insert id="BoardReport" parameterType="hashmap">
	INSERT INTO REPORT
	VALUES(REPORT_SEQ.NEXTVAL, #{reportType}, #{reportedUserId}, #{reason}, #{boardNo} , NULL , 1, #{userId})
	</insert>
	
	<select id="whishList" parameterType="hashmap" resultType="com.example.test1.model.Board">
		SELECT f.*,R2.*,R2.USER_ID as Iduser FROM FAV F
		INNER JOIN TBL_REVIEW R ON R.BOARDNO = R.BOARDNO
		INNER JOIN RESERVATION R2 ON R.RES_NUM = R2.RES_NUM
		WHERE R.BOARDNO = F.BOARDNO AND F.USER_ID = #{userId}
        <if test="tag !=null and tag !=''">
        AND DESCRIPT LIKE '%' || #{tag} || '%'
        </if>
        OFFSET #{page} ROWS FETCH NEXT #{pageSize} ROWS ONLY	
		
	</select>
	
	<select id="cntWhishList" parameterType="hashmap" resultType="int">
		SELECT COUNT(*) FROM FAV F
		INNER JOIN TBL_REVIEW R ON R.BOARDNO = R.BOARDNO
		INNER JOIN RESERVATION R2 ON R.RES_NUM = R2.RES_NUM
		WHERE R.BOARDNO = F.BOARDNO AND F.USER_ID = #{userId}
	
	</select>
	
	<!--신고여부-->
	<select id="reportCheckBoard" parameterType="hashmap" resultType="int">
    SELECT COUNT(*)
    FROM REPORT
    WHERE REPORT_USER_ID = #{userId}
      AND BOARDNO = #{boardNo}
</select>

<!-- 댓글 신고 여부 확인 -->
<select id="reportCheckComment" parameterType="hashmap" resultType="int">
    SELECT COUNT(*)
    FROM REPORT
    WHERE COMMENTNO = #{commentNo}
      AND REPORT_USER_ID = #{userId} 
</select>

<update id="updateComReport" parameterType="hashmap">
   UPDATE REPORT
    SET REPORT_CNT = NVL(REPORT_CNT, 0) + 1
    WHERE COMMENTNO = #{commentNo}
      AND REPORTED_USER_ID = #{reportedUserId}
      AND REPORT_USER_ID = #{userId}
</update>

<insert id="comReport" parameterType="hashmap">
    INSERT INTO REPORT
        (REPORTNUM, REPORT_TYPE, REPORTED_USER_ID, CONTENT, BOARDNO, COMMENTNO, REPORT_CNT, REPORT_USER_ID)
    SELECT REPORT_SEQ.NEXTVAL,
           #{CreportType},
           #{reportedUserId},
           #{comReason},
           NULL,
           #{commentNo},
           1,
           #{userId}
    FROM DUAL
    WHERE NOT EXISTS (
        SELECT 1 FROM REPORT
        WHERE COMMENTNO = #{commentNo}
          AND REPORTED_USER_ID = #{reportedUserId}
          AND REPORT_USER_ID = #{userId}
    )
</insert>

<!--게시글 채택하기 수 -->
<select id="checkAlreadyAdopted" parameterType="int" resultType="int">
    SELECT COUNT(*)
    FROM TBL_COMMENT
    WHERE BOARDNO = #{boardNo}
      AND ADOPT = 'T'
</select>

<select id="noticeList" parameterType="hashmap" resultType="com.example.test1.model.Board">
	SELECT 
		    B.*, 
		    DECODE(TO_CHAR(CDATETIME, 'YYYY-MM-DD'), TO_CHAR(SYSDATE, 'YYYY-MM-DD'),TO_CHAR(CDATETIME,'HH24:MI:SS'),TO_CHAR(CDATETIME, 'YYYY-MM-DD')) AS CDATE, 
		    NVL(CCNT, 0) AS COMMENTCNT , NICKNAME
		FROM TBL_BOARD B
		LEFT JOIN (
		    SELECT BOARDNO, COUNT(*) AS CCNT
		    FROM TBL_COMMENT
		    GROUP BY BOARDNO
		) T ON T.BOARDNO = B.BOARDNO
		INNER JOIN (
			SELECT U1.NICKNAME , U1.USER_ID
			FROM USERS U1
		) U ON B.USER_ID = U.USER_ID
		WHERE TYPE = 'N'
		
		
		<if test="searchOption == 'all'">
		AND (TITLE LIKE '%' || #{keyword} || '%' OR
			B.USER_ID LIKE '%' || #{keyword} || '%'
			)
		 
		</if>
		
		<if test="searchOption == 'id'">
		AND B.USER_ID LIKE '%' || #{keyword} || '%' 
		</if>
		<if test="searchOption == 'title'">
		AND TITLE LIKE '%' || #{keyword} || '%' 
		</if>
		
		
		
		ORDER BY B.CDATETIME DESC
		
		OFFSET #{page} ROWS FETCH NEXT #{pageSize} ROWS ONLY
</select>
	
	<select id="selectNotice" parameterType="hashmap" resultType="int">
	SELECT NVL(COUNT(*), 0)
	FROM TBL_BOARD B
	WHERE TYPE = 'N'
		
		
		<if test="searchOption == 'all'">
		AND (TITLE LIKE '%' || #{keyword} || '%' OR
			USER_ID LIKE '%' || #{keyword} || '%'
			)
		 
		</if>
		
		<if test="searchOption == 'id'">
		AND USER_ID LIKE '%' || #{keyword} || '%' 
		</if>
		<if test="searchOption == 'title'">
		AND TITLE LIKE '%' || #{keyword} || '%' 
		</if>
	</select>
	
	<select id="noticeView" parameterType="hashmap" resultType="com.example.test1.model.Board">
		SELECT *
		FROM TBL_BOARD
		WHERE BOARDNO = #{boardNo} 
	</select>
	
	<select id="bestList" parameterType="hashmap" resultType="com.example.test1.model.Board">
	 	SELECT  * FROM TBL_BOARD
		ORDER BY FAV DESC
		OFFSET 0 ROWS FETCH NEXT 6 ROWS ONLY
	</select>
	<update id="boardFav" parameterType="hashmap">
   UPDATE TBL_BOARD
    SET FAV = FAV +1
    WHERE BOARDNO= #{boardNo}
</update>
	
	
</mapper>
