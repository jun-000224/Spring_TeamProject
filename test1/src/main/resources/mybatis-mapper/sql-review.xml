<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.test1.mapper.ReviewMapper">
	<select id="myResList" parameterType="hashmap" resultType="com.example.test1.model.Review">
		SELECT * FROM RESERVATION 
		WHERE USER_ID = #{userId}		
		ORDER BY RDATETIME DESC
		OFFSET #{page} ROWS FETCH NEXT #{pageSize} ROWS ONLY
	</select>
	
	<select id="myResListCnt" parameterType="hashmap" resultType="int">
		SELECT COUNT(*) FROM RESERVATION 
		WHERE USER_ID = #{userId}		
		ORDER BY RDATETIME DESC
		
	</select>
	
	<select id="reviewList" parameterType="hashmap" resultType="com.example.test1.model.Review">
		SELECT 
        R1.BOARDNO,
        R1.FAV,
        R1.CNT,
        R1.RES_NUM,
        R2.THEMNUM,
        R2.USER_ID,
        R2.PRICE,
        R2.DESCRIPT,
        CASE 
            WHEN F.USER_ID IS NOT NULL THEN 1 
            ELSE 0 
        END AS liked
    FROM TBL_REVIEW R1
    INNER JOIN RESERVATION R2 
        ON R1.RES_NUM = R2.RES_NUM
    LEFT JOIN FAV F 
        ON F.BOARDNO = R1.BOARDNO
        AND F.USER_ID = #{userId}
        WHERE 1=1
        <if test="tag !=null and tag !=''">
        AND DESCRIPT LIKE '%' || #{tag} || '%'
        </if>
    ORDER BY R1.BOARDNO DESC
    OFFSET #{page} ROWS FETCH NEXT #{pageSize} ROWS ONLY		
	</select>
	
	<select id="cntMemberList" parameterType="hashmap" resultType="int">
		SELECT 
			 COUNT(*) cnt
		FROM TBL_REVIEW R1
    INNER JOIN RESERVATION R2 
        ON R1.RES_NUM = R2.RES_NUM
    LEFT JOIN FAV F 
        ON F.BOARDNO = R1.BOARDNO
        AND F.USER_ID = #{userId}
		WHERE 1=1
        <if test="tag !=null and tag !=''">
        AND DESCRIPT LIKE '%' || #{tag} || '%'
        </if>
	</select>
	
	<select id="detailReviewList" parameterType="hashmap" resultType="com.example.test1.model.Review">
		SELECT CONTENT_ID , P.RES_NUM, RATING , CONTENT, U.USER_ID,NICKNAME,TO_CHAR(RESERV_DATE,'YYYY-MM-DD')AS rdatetime  FROM POI P
		INNER JOIN RESERVATION R ON P.RES_NUM = R.RES_NUM
		INNER JOIN USERS U ON R.USER_ID = U.USER_ID
		WHERE P.CONTENT_ID = #{contentId}	
	</select>
	
	<select id="detailReviewImgList" parameterType="hashmap" resultType="com.example.test1.model.Review">
		SELECT * FROM POI P
		INNER JOIN MEDIA M ON P.CONTENT_ID = M.CONTENTID
		WHERE P.CONTENT_ID = #{contentId}
		ORDER BY SORT_NO ASC
	</select>
	
	<select id="selectOldImg" parameterType="hashmap" resultType="string">
    SELECT TITLE
    FROM MEDIA
    WHERE CONTENTID = #{contentId}
      AND USER_ID = #{userId}
     
	</select>
	
	<select id="thumbnailWithResNum" parameterType="hashmap" resultType="com.example.test1.model.Review">
	SELECT R.RES_NUM, CONTENT_ID FROM FAV F
	INNER JOIN TBL_REVIEW R ON F.BOARDNO = R.BOARDNO
	INNER JOIN RESERVATION R2 ON R.RES_NUM = R2.RES_NUM
	INNER JOIN (SELECT RES_NUM, MIN(CONTENT_ID) AS CONTENT_ID
	    FROM POI
	    GROUP BY RES_NUM) R3
	    ON R3.RES_NUM = R2.RES_NUM
	    WHERE 1=1
	    <if test="userId !=null and userId !=''">
	    AND R.BOARDNO = F.BOARDNO AND F.USER_ID = #{userId}
    	</if>
    </select>
	
	<select id="selectFavorite" parameterType="hashmap" resultType="com.example.test1.model.Review">
	
	SELECT * FROM FAV
	WHERE USER_ID= #{userId} AND BOARDNO = #{boardNo}
	</select>
	
	<insert id="resInsert" parameterType="hashmap">
		INSERT INTO TBL_REVIEW
		VALUES(REVIEW_SEQ.NEXTVAL,#{userId},'0','0',SYSDATE,#{resNum})
	</insert>
	
	<insert id="fileUpload" parameterType="hashmap">
		INSERT INTO MEDIA
		VALUES(MEDIA_SEQ.NEXTVAL, #{filename}, #{path}, #{contentId},  (SELECT NVL(MAX(SORT_NO), 0) + 1 FROM MEDIA WHERE CONTENTID = #{contentId}), #{userId}, #{boardNo,jdbcType=NUMERIC})
	</insert>
	
	<insert id="favorite" parameterType="hashmap">
		INSERT INTO FAV
		VALUES(FAV_SEQ.NEXTVAL,#{boardNo},#{userId})
	</insert>
	
	
	<delete id="deleteImg" parameterType="hashmap">
    DELETE FROM MEDIA
    WHERE CONTENTID = #{contentId}
      AND USER_ID = #{userId}
      
	</delete>
	
	<update id="rating" parameterType="hashmap">
		UPDATE POI SET RATING = #{rating} ,CONTENT = #{content}
		WHERE CONTENT_ID = #{contentId} AND RES_NUM = #{resNum}
	</update>
	
	<update id="reviewCnt" parameterType="hashmap">
		UPDATE TBL_REVIEW SET CNT = CNT+1
		WHERE RES_NUM = #{resNum}
	</update>
	
	<update id="reviewFavorite" parameterType="hashmap">
		UPDATE TBL_REVIEW SET FAV = (SELECT COUNT(*) FROM FAV WHERE BOARDNO = #{boardNo})
		WHERE BOARDNO = #{boardNo}
	</update>
	
	<delete id="deletefavorite" parameterType="hashmap">
		DELETE FROM FAV 
		WHERE BOARDNO =#{boardNo} AND USER_ID = #{userId}
	</delete>
		
</mapper>




